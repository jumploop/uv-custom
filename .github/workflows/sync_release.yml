name: Sync UV Release

on:
  workflow_dispatch:
  schedule:
    - cron: '*/5 * * * *'

jobs:
  sync:
    runs-on: ubuntu-latest
    permissions:
      contents: write # Required to create a release
    steps:
      - name: Get latest uv release version
        id: get_uv_version
        run: |
          LATEST_UV_JSON=$(curl -sL -H "Authorization: Bearer ${{ secrets.GITHUB_TOKEN }}" https://api.github.com/repos/astral-sh/uv/releases/latest)
          LATEST_UV_TAG=$(echo "$LATEST_UV_JSON" | jq -r .tag_name)
          LATEST_UV_NOTES=$(echo "$LATEST_UV_JSON" | jq -r .body)
          echo "tag=$LATEST_UV_TAG" >> $GITHUB_OUTPUT
          echo "notes<<EOF" >> $GITHUB_OUTPUT
          echo "$LATEST_UV_NOTES" >> $GITHUB_OUTPUT
          echo "EOF" >> $GITHUB_OUTPUT

      - name: Get latest local release version
        id: get_local_version
        run: |
          LATEST_LOCAL_TAG=$(curl -sL -H "Authorization: Bearer ${{ secrets.GITHUB_TOKEN }}" https://api.github.com/repos/${{ github.repository }}/releases/latest | jq -r .tag_name)
          echo "tag=$LATEST_LOCAL_TAG" >> $GITHUB_OUTPUT

      - name: Compare versions and decide to proceed
        id: compare_versions
        run: |
          echo "Latest uv release: ${{ steps.get_uv_version.outputs.tag }}"
          echo "Latest local release: ${{ steps.get_local_version.outputs.tag }}"
          if [ "${{ steps.get_uv_version.outputs.tag }}" = "${{ steps.get_local_version.outputs.tag }}" ]; then
            echo "Versions are the same. No new release needed."
            echo "proceed=false" >> $GITHUB_OUTPUT
          else
            echo "New version detected. Proceeding with release."
            echo "proceed=true" >> $GITHUB_OUTPUT
          fi

      - name: Checkout repository
        if: steps.compare_versions.outputs.proceed == 'true'
        uses: actions/checkout@v4

      - name: Generate custom installers
        if: steps.compare_versions.outputs.proceed == 'true'
        run: |
          chmod +x ./create_custom_uv_installer.sh
          ./create_custom_uv_installer.sh ${{ steps.get_uv_version.outputs.tag }}

      - name: Create new release
        if: steps.compare_versions.outputs.proceed == 'true'
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
          RELEASE_TAG: ${{ steps.get_uv_version.outputs.tag }}
          REPO_URL: "https://github.com/${{ github.repository }}"
        run: |
          # Generate custom release notes
          cat > release_notes.md <<EOF
          ## ðŸš€ uv å›½å†…åŠ é€Ÿç‰ˆ

          è¿™æ˜¯ä¸€ä¸ªä¸Ž uv å®˜æ–¹ç‰ˆæœ¬ **[$RELEASE_TAG](https://github.com/astral-sh/uv/releases/tag/$RELEASE_TAG)** åŒæ­¥çš„é•œåƒç‰ˆæœ¬ï¼Œä¸ºå›½å†…ç”¨æˆ·æä¾›äº†ä»¥ä¸‹ä¼˜åŒ–ï¼š

          - **ä¸‹è½½åŠ é€Ÿ**ï¼šæ‰€æœ‰uvå¯æ‰§è¡Œç¨‹åºçš„ GitHub ä¸‹è½½é“¾æŽ¥å‡é€šè¿‡é•œåƒä»£ç†ï¼Œå¤§å¹…æå‡ä¸‹è½½é€Ÿåº¦ã€‚
          - **é¢„è®¾é•œåƒ**ï¼šè‡ªåŠ¨ä¸ºæ‚¨é…ç½®æ¸…åŽå¤§å­¦ PyPI é•œåƒå’Œ Github ä»£ç†çš„ Python æž„å»ºé•œåƒã€‚

          ---

          ### å¿«é€Ÿå®‰è£…

          è¯·æ ¹æ®æ‚¨çš„æ“ä½œç³»ç»Ÿï¼Œåœ¨ç»ˆç«¯ä¸­è¿è¡Œä»¥ä¸‹å¯¹åº”çš„ä¸€é”®å®‰è£…å‘½ä»¤ï¼š

          #### macOS / Linux
          \`\`\`sh
          curl -LsSf $REPO_URL/releases/download/$RELEASE_TAG/uv-installer-custom.sh | sh
          \`\`\`

          #### Windows (PowerShell)
          \`\`\`powershell
          powershell -ExecutionPolicy Bypass -c "irm $REPO_URL/releases/download/$RELEASE_TAG/uv-installer-custom.ps1 | iex"
          \`\`\`

          ---

          ### (å¯é€‰) é…ç½® Conda/Mamba çŽ¯å¢ƒè”åŠ¨

          å¦‚æžœæ‚¨å¸Œæœ› \`uv\` èƒ½å¤Ÿè‡ªåŠ¨è¯†åˆ«å¹¶ç®¡ç†å½“å‰æ¿€æ´»çš„ Conda/Mamba çŽ¯å¢ƒï¼Œå¯ä»¥è¿è¡Œä»¥ä¸‹å¯¹åº”çš„è„šæœ¬æ¥é…ç½® Shell é’©å­ã€‚

          #### macOS / Linux
          \`\`\`sh
          curl -LsSf $REPO_URL/releases/download/$RELEASE_TAG/setup_hooks.sh | sh
          \`\`\`

          #### Windows (PowerShell)
          \`\`\`powershell
          powershell -ExecutionPolicy Bypass -c "irm $REPO_URL/releases/download/$RELEASE_TAG/setup_hooks.ps1 | iex"
          \`\`\`
          EOF

          gh release create "$RELEASE_TAG" \
            --title "$RELEASE_TAG" \
            --notes-file release_notes.md \
            uv-installer-custom.sh \
            uv-installer-custom.ps1 \
            setup_hooks.sh \
            setup_hooks.ps1