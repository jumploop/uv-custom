name: Sync UV Release to GitHub & Gitee

on:
  workflow_dispatch:
  schedule:
    - cron: '*/5 * * * *'

jobs:
  check_for_updates:
    runs-on: ubuntu-latest
    outputs:
      proceed: ${{ steps.compare_versions.outputs.proceed }}
      new_tag: ${{ steps.get_uv_version.outputs.tag }}
    steps:
      - name: Get latest uv release version
        id: get_uv_version
        run: |
          LATEST_UV_JSON=$(curl -sL -H "Authorization: Bearer ${{ secrets.GITHUB_TOKEN }}" https://api.github.com/repos/astral-sh/uv/releases/latest)
          LATEST_UV_TAG=$(echo "$LATEST_UV_JSON" | jq -r .tag_name)
          echo "tag=$LATEST_UV_TAG" >> $GITHUB_OUTPUT

      - name: Get latest GitHub local release version
        id: get_github_local_version
        run: |
          LATEST_GITHUB_TAG=$(curl -sL -H "Authorization: Bearer ${{ secrets.GITHUB_TOKEN }}" https://api.github.com/repos/${{ github.repository }}/releases/latest | jq -r .tag_name)
          echo "tag=$LATEST_GITHUB_TAG" >> $GITHUB_OUTPUT

      - name: Get latest Gitee local release version
        id: get_gitee_local_version
        env:
          GITEE_TOKEN: ${{ secrets.GITEE_TOKEN }}
          GITEE_OWNER: "wangnov"
          GITEE_REPO: "uv-mirror"
        run: |
          LATEST_GITEE_TAG=$(curl -sL "https://gitee.com/api/v5/repos/$GITEE_OWNER/$GITEE_REPO/releases/latest?access_token=$GITEE_TOKEN" | jq -r .tag_name)
          echo "tag=$LATEST_GITEE_TAG" >> $GITHUB_OUTPUT

      - name: Compare versions and decide to proceed
        id: compare_versions
        run: |
          echo "Latest uv release: ${{ steps.get_uv_version.outputs.tag }}"
          echo "Latest GitHub local release: ${{ steps.get_github_local_version.outputs.tag }}"
          echo "Latest Gitee local release: ${{ steps.get_gitee_local_version.outputs.tag }}"
          if [ "${{ steps.get_uv_version.outputs.tag }}" = "${{ steps.get_github_local_version.outputs.tag }}" ] && \
             [ "${{ steps.get_uv_version.outputs.tag }}" = "${{ steps.get_gitee_local_version.outputs.tag }}" ]; then
            echo "All repositories are up-to-date. No new release needed."
            echo "proceed=false" >> $GITHUB_OUTPUT
          else
            echo "New version detected or repositories are out of sync. Proceeding with release."
            echo "proceed=true" >> $GITHUB_OUTPUT
          fi

  create_releases:
    needs: check_for_updates
    if: needs.check_for_updates.outputs.proceed == 'true'
    runs-on: ubuntu-latest
    permissions:
      contents: write
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Generate custom installers
        run: |
          chmod +x ./create_custom_uv_installer.sh
          ./create_custom_uv_installer.sh ${{ needs.check_for_updates.outputs.new_tag }}

      - name: Generate Release Notes
        id: generate_notes
        run: |
          RELEASE_TAG="${{ needs.check_for_updates.outputs.new_tag }}"
          GITHUB_REPO_URL="https://github.com/${{ github.repository }}"
          GITEE_REPO_URL="https://gitee.com/wangnov/uv-mirror" # Replace with your Gitee repo URL

          # Notes for GitHub (Gitee is primary)
          cat > github_notes.md <<EOF
          ## ðŸš€ uv å›½å†…åŠ é€Ÿç‰ˆ (åŒæ­¥è‡ª [$RELEASE_TAG](https://github.com/astral-sh/uv/releases/tag/$RELEASE_TAG))

          **æŽ¨èä½¿ç”¨ Gitee æºä»¥èŽ·å¾—æœ€ä½³ä¸‹è½½é€Ÿåº¦ã€‚**

          ### Gitee (ä¸»æŽ¨)
          \`\`\`sh
          # macOS / Linux
          curl -LsSf $GITEE_REPO_URL/releases/download/$RELEASE_TAG/uv-installer-custom.sh | sh
          # Windows (PowerShell)
          powershell -ExecutionPolicy Bypass -c "irm $GITEE_REPO_URL/releases/download/$RELEASE_TAG/uv-installer-custom.ps1 | iex"
          \`\`\`

          ### GitHub (å¤‡ç”¨)
          \`\`\`sh
          # macOS / Linux
          curl -LsSf $GITHUB_REPO_URL/releases/download/$RELEASE_TAG/uv-installer-custom.sh | sh
          \`\`\`
          EOF

          # Notes for Gitee (Gitee is primary)
          cat > gitee_notes.md <<EOF
          ## ðŸš€ uv å›½å†…åŠ é€Ÿç‰ˆ (åŒæ­¥è‡ª uvå®˜æ–¹ç‰ˆæœ¬ [$RELEASE_TAG](https://github.com/astral-sh/uv/releases/tag/$RELEASE_TAG))

          è¿™æ˜¯ä¸€ä¸ªä¸Ž uv å®˜æ–¹ç‰ˆæœ¬åŒæ­¥çš„é•œåƒç‰ˆæœ¬ï¼Œä¸ºå›½å†…ç”¨æˆ·æä¾›äº†ä»¥ä¸‹ä¼˜åŒ–ï¼š

          - **ä¸‹è½½åŠ é€Ÿ**ï¼šæ‰€æœ‰ GitHub ä¸‹è½½é“¾æŽ¥å‡é€šè¿‡é•œåƒä»£ç†ï¼Œå¤§å¹…æå‡ä¸‹è½½é€Ÿåº¦ã€‚
          - **é¢„è®¾é•œåƒ**ï¼šè‡ªåŠ¨ä¸ºæ‚¨é…ç½®æ¸…åŽå¤§å­¦ PyPI é•œåƒå’Œ Python æž„å»ºé•œåƒã€‚

          ---

          ### å¿«é€Ÿå®‰è£… (Gitee æº)

          è¯·æ ¹æ®æ‚¨çš„æ“ä½œç³»ç»Ÿï¼Œåœ¨ç»ˆç«¯ä¸­è¿è¡Œä»¥ä¸‹å¯¹åº”çš„ä¸€é”®å®‰è£…å‘½ä»¤ï¼š

          #### macOS / Linux
          \`\`\`sh
          curl -LsSf $GITEE_REPO_URL/releases/download/$RELEASE_TAG/uv-installer-custom.sh | sh
          \`\`\`

          #### Windows (PowerShell)
          \`\`\`powershell
          powershell -ExecutionPolicy Bypass -c "irm $GITEE_REPO_URL/releases/download/$RELEASE_TAG/uv-installer-custom.ps1 | iex"
          \`\`\`

          ---

          ### (å¯é€‰) é…ç½® Conda/Mamba çŽ¯å¢ƒè”åŠ¨

          å¦‚æžœæ‚¨å¸Œæœ› \`uv\` èƒ½å¤Ÿè‡ªåŠ¨è¯†åˆ«å¹¶ç®¡ç†å½“å‰æ¿€æ´»çš„ Conda/Mamba çŽ¯å¢ƒï¼Œå¯ä»¥è¿è¡Œä»¥ä¸‹å¯¹åº”çš„è„šæœ¬æ¥é…ç½® Shell é’©å­ã€‚

          #### macOS / Linux
          \`\`\`sh
          curl -LsSf $GITEE_REPO_URL/releases/download/$RELEASE_TAG/setup_hooks.sh | sh
          \`\`\`

          #### Windows (PowerShell)
          \`\`\`powershell
          powershell -ExecutionPolicy Bypass -c "irm $GITEE_REPO_URL/releases/download/$RELEASE_TAG/setup_hooks.ps1 | iex"
          \`\`\`
          EOF

      - name: Create GitHub Release
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          gh release create "${{ needs.check_for_updates.outputs.new_tag }}" \
            --title "${{ needs.check_for_updates.outputs.new_tag }}" \
            --notes-file github_notes.md \
            uv-installer-custom.sh \
            uv-installer-custom.ps1 \
            setup_hooks.sh \
            setup_hooks.ps1

      - name: Create Gitee Release
        env:
          GITEE_TOKEN: ${{ secrets.GITEE_TOKEN }}
          RELEASE_TAG: ${{ needs.check_for_updates.outputs.new_tag }}
          GITEE_OWNER: "wangnov" # Replace with your Gitee username/org
          GITEE_REPO: "uv-mirror"  # Replace with your Gitee repo name
        run: |
          set -x
          # Properly escape the notes for JSON payload
          JSON_NOTES=$(jq -R -s '.' < gitee_notes.md)

          # Check if tag already exists on Gitee
          TAG_EXISTS=$(curl -s "https://gitee.com/api/v5/repos/$GITEE_OWNER/$GITEE_REPO/tags/$RELEASE_TAG?access_token=$GITEE_TOKEN" | jq -r .name)

          if [ "$TAG_EXISTS" = "$RELEASE_TAG" ]; then
            echo "Tag $RELEASE_TAG already exists on Gitee. Skipping tag creation."
          else
            echo "Creating Gitee Tag..."
            curl -X POST --header 'Content-Type: application/json;charset=UTF-8' "https://gitee.com/api/v5/repos/$GITEE_OWNER/$GITEE_REPO/tags" \
            -d "{\"access_token\":\"$GITEE_TOKEN\",\"tag_name\":\"$RELEASE_TAG\",\"refs\":\"main\",\"tag_message\":\"Release $RELEASE_TAG\"}"
          fi

          echo "Creating Gitee Release..."
          RELEASE_PAYLOAD=$(jq -n --arg tag "$RELEASE_TAG" --arg notes "$JSON_NOTES" \
            '{ "access_token": "'"$GITEE_TOKEN"'", "tag_name": $tag, "name": $tag, "body": $notes, "target_commitish": "main" }')
          
          RELEASE_RESPONSE=$(curl -X POST --header 'Content-Type: application/json;charset=UTF-8' \
            "https://gitee.com/api/v5/repos/$GITEE_OWNER/$GITEE_REPO/releases" -d "$RELEASE_PAYLOAD")

          RELEASE_ID=$(echo "$RELEASE_RESPONSE" | jq -r .id)
          echo "Gitee Release ID: $RELEASE_ID"

          if [ -z "$RELEASE_ID" ] || [ "$RELEASE_ID" = "null" ]; then
            echo "Failed to create Gitee release or parse its ID."
            echo "Response: $RELEASE_RESPONSE"
            exit 1
          fi

          echo "Uploading assets to Gitee..."
          for asset in uv-installer-custom.sh uv-installer-custom.ps1 setup_hooks.sh setup_hooks.ps1; do
            echo "Uploading $asset..."
            curl -X POST --header "Content-Type: multipart/form-data" \
            -F "access_token=$GITEE_TOKEN" \
            -F "file=@$asset" \
            "https://gitee.com/api/v5/repos/$GITEE_OWNER/$GITEE_REPO/releases/$RELEASE_ID/attach_files"
          done
          echo "All assets uploaded to Gitee."